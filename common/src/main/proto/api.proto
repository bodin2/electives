syntax = "proto3";

package th.ac.bodin2.electives.proto.api;

option java_multiple_files = true;
option java_package = "th.ac.bodin2.electives.proto.api";

message AuthService {
  message AuthenticateRequest {
    fixed32 id = 1;
    string password = 2;
    string client_name = 3;
  }

  message AuthenticateResponse {
    string token = 1;
  }
}

message ElectivesService {
  message ListResponse {
    repeated Elective electives = 1;
  }

  message ListSubjectsResponse {
    repeated Subject subjects = 1;
  }

  message ListSubjectsCountsResponse {
    map<uint32, uint32> subject_enrolled_counts = 1;
  }

  message ListSubjectMembersResponse {
    repeated User teachers = 1;
    repeated User students = 2;
  }
}

message UsersService {
  message GetStudentSelectionsResponse {
    // Elective ID -> Subject
    map<uint32, Subject> subjects = 1;
  }

  message SetStudentElectiveSelectionRequest {
    uint32 subject_id = 1;
  }
}

message NotificationsService {
  message Envelope {
    enum MessageType {
      SUBJECT_ENROLLMENT_UPDATE_SUBSCRIPTION_REQUEST = 0;
      SUBJECT_ENROLLMENT_UPDATE = 1;
      BULK_SUBJECT_ENROLLMENT_UPDATE = 2;
      ACKNOWLEDGED = 3;
    }

    MessageType type = 1;
    optional uint64 message_id = 2;

    oneof payload {
      SubjectEnrollmentUpdateSubscriptionRequest subject_enrollment_update_subscription_request = 3;
      SubjectEnrollmentUpdate subject_enrollment_update = 4;
      BulkSubjectEnrollmentUpdate bulk_subject_enrollment_update = 5;
      Acknowledged acknowledged = 6;
    }
  }

  // Server acknowledges the client message with the given `message_id`.
  message Acknowledged {}

  // Request to subscribe to updates for specific subjects
  message SubjectEnrollmentUpdateSubscriptionRequest {
    // Elective ID -> (subscription data)
    map<uint32, SubjectEnrollmentUpdateSubscription> subscriptions = 1;
  }

  message SubjectEnrollmentUpdateSubscription {
    /**
     * List of subject IDs to subscribe to for updates.
     *
     * The server may limit the number of subjects a client can subscribe to.
     */
    repeated uint32 subject_ids = 1;
  }

  // Sent immediately for important UI updates
  message SubjectEnrollmentUpdate {
    uint32 elective_id = 1;
    uint32 subject_id = 2;
    uint32 enrolled_count = 3;
  }

  // Sent every so often for non-important UI updates
  message BulkSubjectEnrollmentUpdate {
    uint32 elective_id = 1;
    map<uint32, uint32> subject_enrolled_counts = 2;
  }
}

message Team {
  uint32 id = 1;
  string name = 2;
}

message Elective {
  uint32 id = 1;
  string name = 2;
  // Unix timestamp representing the start and end dates of the selection period
  optional fixed64 start_date = 3;
  // Unix timestamp representing the end date of the selection period
  optional fixed64 end_date = 4;
  uint32 team_id = 5;
}

message Subject {
  uint32 id = 1;
  string name = 2;
  optional string description = 3;
  string code = 4;
  SubjectTag tag = 5;
  string location = 6;
  uint32 capacity = 7;
  optional uint32 team_id = 8;
  repeated User teachers = 9;
  // Only passed in ListSubjectsResponse
  optional uint32 enrolled_count = 10;
}

message User {
  uint32 id = 1;
  string first_name = 2;
  optional string middle_name = 3;
  string last_name = 4; 
  UserType type = 5;
  optional bytes avatar = 6;
  // Only passed for Students
  repeated Team teams = 7;
}

enum UserType {
  STUDENT = 0;
  TEACHER = 1;
}

enum SubjectTag {
  THAI = 0;
  MATH = 1;
  SCIENCE_AND_TECHNOLOGY = 2;
  SOCIAL_STUDIES = 3;
  ART = 4;
  PHYSICAL_EDUCATION = 5;
  HOME_ECONOMICS = 6;
  FOREIGN_LANGUAGE = 7;
  GUIDANCE_AND_CAREER = 8;
  ENGLISH_PROGRAM = 9;
  // กิจกรรมพัฒนาผู้เรียน
  ACTIVITIES = 10;
}